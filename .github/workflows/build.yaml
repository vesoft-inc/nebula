name: build

on:
  push:
    branches:
      - master
    paths-ignore:
      - 'docs/**'

jobs:
  build:
    name: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        tag:
          - centos6
          - centos7
          - ubuntu1604
          - ubuntu1804
        compiler: [gcc, clang]
        exclude:
          - tag: centos6
            compiler: clang
          - tag: centos7
            compiler: clang
    steps:
      - uses: actions/checkout@v1
        with:
          fetch-depth: 1
      - name: Mount tmpfs
        run: |
          mkdir -p ${{ github.workspace }}/.cache
          sudo mount -t tmpfs -o size=1G tmpfs ${{ github.workspace }}/.cache
      - uses: actions/cache@v1
        with:
          path: ${{ github.workspace }}/.cache/ccache
          key: ${{ matrix.tag }}-${{ matrix.compiler }}-${{ hashFiles('**/CMakeLists.txt') }}
          restore-keys: |
            ${{ matrix.tag }}-${{ matrix.compiler }}-
      - name: Pull dev docker image
        run: docker pull vesoft/nebula-dev:${{ matrix.tag }}
      - name: Build and test
        timeout-minutes: 80
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/home/nebula \
            -e CCACHE_DIR=/home/nebula/.cache/ccache \
            --entrypoint ./ci/scripts/build-and-test-${{ matrix.compiler }}.sh \
            vesoft/nebula-dev:${{ matrix.tag }}
