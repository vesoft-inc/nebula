# 源码编译安装

# 简介
从源代码编译安装 Nebula Graph，大体分为四步：

1. 克隆代码
2. 安装依赖
3. 安装 GCC 和 CMake
4. 编译安装 Nebula Graph

其中，如果您的系统中已经安装了 GCC 7.0+ 和 CMake 3.5+，第三步可以略过。
# 第一步：克隆代码
```bash
$ git clone https://github.com/vesoft-inc/nebula.git && cd nebula
nebula$ mkdir build && cd build
```
# 第二步：安装依赖
## Redhat/CentOS/Fedora 安装命令

```bash
$ sudo yum install -y make \
                      m4 \
                      wget \
                      unzip \
                      xz \
                      patch \
                      python \
                      redhat-lsb-core \
                      perl-Data-Dumper \
                      perl-Thread-Queue \
                      readline-devel \
                      ncurses-devel \
                      zlib-devel \
                      gcc \
                      gcc-c++ \
                      cmake \
                      libtool \
                      autoconf \
                      automake \
                      bison \
                      flex \
                      gperf \
                      gettext
# Red Hat 7+ 可额外安装 autoconf-archive
$ sudo yum install -y autoconf-archive
```

## Debian/Ubuntu/Mint 安装命令
```bash
$ sudo apt-get update
$ sudo apt-get install -y make \
                          m4 \
                          wget \
                          unzip \
                          xz-utils \
                          patch \
                          python \
                          lsb-core \
                          libz-dev \
                          build-essential \
                          libreadline-dev \
                          ncurses-dev \
                          build-essential \
                          cmake \
                          libtool \
                          automake \
                          autoconf \
                          autoconf-archive \
                          autotools-dev \
                          bison \
                          flex \
                          gperf \
                          gettext
```

# 第三步：安装 CMake 和 GCC
**若您的系统为 Ubuntu 18.04+，CentOS 8+，Red Hat 8+，或其他提供 GCC 7+ 和 CMake 3.5+ 的 Linux 发行版，可从官方源安装，此步可跳过。**可使用下面命令查看 GCC 与 CMake 的版本号：
```bash
$ gcc --version
$ cmake --version
```

## 安装 CMake
以下命令，假设当前目录为 nebula/build，如果您的情况有所不同，请自行调整相应路径。
```bash
# 脚本自动下载安装 CMake
nebula/build$ ../third-party/install-cmake.sh
# 安装完成，将 cmake 命令加入 PATH（假设 CMake 版本为 3.15.5）
nebula/build$ source cmake-3.15.5/bin/enable-cmake.sh
```

## 安装 GCC
### 包管理器安装
#### CentOS 6 / CentOS 7
```bash
# 安装 SCL，即 Software Collection
$ sudo yum install centos-release-scl
# 安装 devtoolset
$ sudo yum install devtoolset-7
# 设置 PATH 等相关变量，启用 devtoolset
$ scl enable devtoolset-7 bash
# 重设命令搜索缓存
$ hash -r
# 确认 GCC 版本
$ g++ --version
g++ (GCC) 7.3.1 20180303 (Red Hat 7.3.1-5)
```

#### Red Hat 6 / Red Hat 7
```bash
# 安装 SCL，即 Software Collection

# Red Hat 6
$ sudo yum-config-manager --enable rhel-server-rhscl-6-rpms
# Red Hat 7
$ sudo yum-config-manager --enable rhel-server-rhscl-7-rpms

# 安装 devtoolset
$ sudo yum install devtoolset-7
# 设置 PATH 等相关变量，启用 devtoolset
$ scl enable devtoolset-7 bash
# 重设命令搜索缓存
$ hash -r
# 确认 GCC 版本
$ g++ --version
g++ (GCC) 7.3.1 20180303 (Red Hat 7.3.1-5)
```

#### Ubuntu 14.04 / Ubuntu 16.04
```bash
$ sudo apt-get install -y software-properties-common
$ sudo add-apt-repository ppa:ubuntu-toolchain-r/test
$ sudo apt-get update
$ sudo apt-get install -y gcc-7 g++-7
$ export CC=gcc-7
$ export CXX=g++-7
```

### 使用我们预先编译好的GCC
若系统是 Debian 或其他未提及的 Linux 发行版，您可以执行我们提供的脚本下载安装 GCC：
```bash
# 自动下载安装
nebula/build$ ../third-party/install-gcc.sh --prefix=/opt/nebula/toolset
GCC-7.5.0 has been installed to /opt/nebula/toolset/gcc/7.5.0
Performing usability tests
Performing regular C++14 tests...OK
Performing LeakSanitizer tests...OK
Run 'source /opt/nebula/toolset/gcc/7.5.0/enable' to start using.

# 修改环境变量（方便起见，您可以手动加入 $HOME/.bashrc）
nebula/build$ source /opt/nebula/toolset/gcc/7.5.0/enable

# 确认新的编译器已经生效
nebula/build$ which g++
/opt/nebula/toolset/gcc/7.5.0/bin/g++
nebula/build$ $CXX -v
g++ (Nebula Graph Build) 7.5.0
...
```

### 源码安装
```bash
nebula/build$ ../third-party/build-gcc.sh
```

# 第四步：编译 Nebula Graph
```bash
# 注意 build-third-party.sh 和 cmake 命令需要在同一目录下运行
nebula/build$ ../third-party/build-third-party.sh
nebula/build$ cmake -DENABLE_TESTING=OFF \
                    -DCMAKE_BUILD_TYPE=Release \
                    -DCMAKE_INSTALL_PREFIX=$HOME/nebula-install \
                    ..
nebula/build$ make -j && make install
nebula/build$ cd $HOME/nebula-install
nebula-install$ ls
bin/ share/ etc/ scripts/
```


# 常见问题和解决方案

- **错误信息**: `[ERROR] No compiler is provided in this environment. Perhaps you are running on a JRE rather than a JDK?`

    **解决方案**:
    1) 运行 `java -version` 来获取 jdk 版本信息
    2) 如果你的 jdk 版本不是 `1.8.0_xxx`，请安装

    **Ubuntu**

    ```bash
    sudo apt-get -y install openjdk-8-jdk
    ```

    **CentOS**

    ```bash
    sudo yum -y install java-1.8.0-openjdk
    ```

    3) 在 **~/.bashrc** 末添加

    **Ubuntu**

    ```bash
    export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-amd64
    export JRE_HOME=$JAVA_HOME/jre
    export CLASSPATH=$JAVA_HOME/lib:$JRE_HOME/lib:$CLASSPATH
    export PATH=$JAVA_HOME/bin:$JRE_HOME/bin:$PATH
    ```

    **CentOS**

    ```bash
    export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk
    export JRE_HOME=$JAVA_HOME/jre
    export CLASSPATH=$JAVA_HOME/lib:$JRE_HOME/lib:$CLASSPATH
    export PATH=$JAVA_HOME/bin:$JRE_HOME/bin:$PATH
    ```
